services:

  postgres_test:
    image: docker.arvancloud.ir/postgres:16
    container_name: postgres_test
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_test:/var/lib/postgresql/data
    networks:
      - test
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "24m"
        max-file: "10"

  redis_test:
    image: docker.arvancloud.ir/redis:7.2
    container_name: redis_test
    networks:
      - test
    depends_on:
      - postgres_test
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "24m"
        max-file: "10"

  mongodb_test:
    container_name: mongodb_test
    image: docker.arvancloud.ir/mongo:7.0.5
    volumes:
      - mongodb_test:/data/db
    networks:
      - test
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "24m"
        max-file: "10"

  api_test:
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}
      - MELIPAYAMAK_USERNAME=${MELIPAYAMAK_USERNAME}
      - MELIPAYAMAK_PASSOWRD=${MELIPAYAMAK_PASSOWRD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - ZARINPAL_MERCHANTID=${ZARINPAL_MERCHANTID}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
    build:
      context: .
      dockerfile: Dockerfile.api.prod
      args:
        - SECRET_KEY=${SECRET_KEY}
        - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}
        - MELIPAYAMAK_USERNAME=${MELIPAYAMAK_USERNAME}
        - MELIPAYAMAK_PASSOWRD=${MELIPAYAMAK_PASSOWRD}
        - POSTGRES_DB=${POSTGRES_DB}
        - POSTGRES_USER=${POSTGRES_USER}
        - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
        - ZARINPAL_MERCHANTID=${ZARINPAL_MERCHANTID}
        - ADMIN_PASSWORD=${ADMIN_PASSWORD}
    image: api_test
    container_name: api_test
    entrypoint: ["/code/infra/entrypoints/api_test.sh"]
    volumes:
      - ticket_appendix:/code/media/tickets/
      - django_logs:/code/logs/
    networks:
      - test
    depends_on:
      - postgres_test
      - redis_test
      - mongodb_test
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "24m"
        max-file: "10"

  apscheduler_test:
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}
      - MELIPAYAMAK_USERNAME=${MELIPAYAMAK_USERNAME}
      - MELIPAYAMAK_PASSOWRD=${MELIPAYAMAK_PASSOWRD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - ZARINPAL_MERCHANTID=${ZARINPAL_MERCHANTID}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
    build:
      context: .
      dockerfile: Dockerfile.api.prod
      args:
        - SECRET_KEY=${SECRET_KEY}
        - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}
        - MELIPAYAMAK_USERNAME=${MELIPAYAMAK_USERNAME}
        - MELIPAYAMAK_PASSOWRD=${MELIPAYAMAK_PASSOWRD}
        - POSTGRES_DB=${POSTGRES_DB}
        - POSTGRES_USER=${POSTGRES_USER}
        - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
        - ZARINPAL_MERCHANTID=${ZARINPAL_MERCHANTID}
        - ADMIN_PASSWORD=${ADMIN_PASSWORD}
    image: apscheduler_test
    container_name: apscheduler_test
    entrypoint: ["/code/infra/entrypoints/apscheduler_test.sh"]
    networks:
      - test
    depends_on:
      - postgres_test
      - redis_test
      - mongodb_test
      - api_test
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "24m"
        max-file: "10"

  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx.test
    image: nginx_test
    container_name: nginx_test
    ports:
      - "80:80"
    restart: always
    depends_on:
      - api_test
    networks:
      - test
    volumes:
      - nginx_logs:/var/log/nginx/

  wordpress:
    environment:
      - WORDPRESS_DB_HOST=${WORDPRESS_DB_HOST}
      - WORDPRESS_DB_NAME=${WORDPRESS_DB_NAME}
      - WORDPRESS_DB_USER=${WORDPRESS_DB_USER}
      - WORDPRESS_DB_PASSWORD=${WORDPRESS_DB_PASSWORD}
    image: docker.arvancloud.ir/wordpress:6.6.2
    container_name: wordpress
    restart: always
    volumes:
      - wordpress_data:/var/www/html
    depends_on:
      - db
    networks:
      - test

  db:
    image: docker.arvancloud.ir/mariadb:11.5.2
    container_name: wordpress_db
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${WORDPRESS_DB_NAME}
      - MYSQL_USER=${WORDPRESS_DB_USER}
      - MYSQL_PASSWORD=${WORDPRESS_DB_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - test

  phpmyadmin:
    image: docker.arvancloud.ir/phpmyadmin:5.2.1
    container_name: phpmyadmin
    restart: always
    environment:
      - PMA_HOST=db
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    depends_on:
      - db
    networks:
      - test

networks:
  test:
    external: true
    driver: bridge
    name: test

volumes:
  postgres_test:
  mongodb_test:
  ticket_appendix:
  django_logs:
  nginx_logs:
  wordpress_data:
  db_data: